<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mémoire - Nothing Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
<style>
:root {
  --bg: #000000;
  --card: #111111;
  --text-main: #FFFFFF;
  --text-dim: #888888;
  --accent-red: #EB4432;
  --border: #222222;
  --dot-font: 'Space Mono', monospace;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; user-select: none; }
body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); padding-bottom: 120px; touch-action: pan-y; }

/* ── HEADER ── */
.app-header { position: sticky; top: 0; z-index: 1000; background: rgba(0,0,0,0.8); backdrop-filter: blur(20px); padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
.logo { font-family: var(--dot-font); font-weight: 700; font-size: 18px; text-transform: uppercase; letter-spacing: 1px; }

/* ── SEARCH ── */
.search-container { padding: 16px 20px 0 20px; }
.search-bar { background: var(--card); border: 1px solid var(--border); border-radius: 100px; padding: 12px 20px; display: flex; align-items: center; gap: 10px; }
.search-bar input { background: none; border: none; outline: none; color: white; width: 100%; font-size: 14px; }

/* ── GRID & CARDS ── */
.cards-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 20px; }
.card {
  background: var(--card); border-radius: 28px; padding: 20px; border: 1px solid var(--border);
  transition: transform 0.2s cubic-bezier(0.2, 0, 0, 1), background 0.2s;
  display: flex; flex-direction: column; justify-content: space-between; min-height: 160px;
  position: relative; overflow: hidden;
}
.card.pressing { transform: scale(0.94); background: #1a1a1a; }
.card.pinned { border: 1px solid #444; }
.pin-dot { position: absolute; top: 15px; right: 15px; width: 8px; height: 8px; background: var(--accent-red); border-radius: 50%; box-shadow: 0 0 10px var(--accent-red); }

.card-type { font-family: var(--dot-font); font-size: 10px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px; }
.card-title { font-weight: 600; font-size: 16px; margin-bottom: 6px; color: white; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.card-content { font-size: 13px; color: var(--text-dim); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
.card-date { font-family: var(--dot-font); font-size: 9px; color: var(--text-dim); margin-top: 15px; }

/* ── CONTEXT MENU ── */
.context-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 3000; display: none; align-items: center; justify-content: center; }
.context-menu { background: #1a1a1a; border: 1px solid var(--border); border-radius: 28px; width: 220px; padding: 10px; }
.menu-item { padding: 15px; display: flex; align-items: center; gap: 12px; color: white; font-size: 15px; border-radius: 20px; }
.menu-item:active { background: #333; }
.menu-item.delete { color: var(--accent-red); }

/* ── MODALS ── */
.popup-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; align-items: center; justify-content: center; }
.choice-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; width: 85%; }
.choice-item { background: var(--card); border: 1px solid var(--border); border-radius: 32px; aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; }
.choice-item span { font-family: var(--dot-font); font-size: 11px; text-transform: uppercase; }

.modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 2500; display: none; align-items: flex-end; }
.modal-sheet { background: var(--card); width: 100%; border-radius: 32px 32px 0 0; padding: 30px 20px; border-top: 1px solid var(--border); transition: transform 0.3s ease-out; transform: translateY(100%); }
.modal-overlay.active .modal-sheet { transform: translateY(0); }
.modal-sheet input, .modal-sheet textarea { width: 100%; background: #1a1a1a; border: 1px solid var(--border); border-radius: 16px; padding: 16px; color: white; margin-bottom: 12px; outline: none; font-size: 16px; }

.save-btn { width: 100%; padding: 18px; background: white; color: black; border: none; border-radius: 100px; font-weight: 700; font-family: var(--dot-font); }

.fab { position: fixed; bottom: 30px; right: 24px; background: white; color: black; width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 500; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
</style>
</head>
<body>

<header class="app-header">
  <div class="logo">MÉMOIRE.</div>
  <span class="material-icons-round" style="color:var(--text-dim)">more_vert</span>
</header>

<div class="search-container">
    <div class="search-bar">
        <span class="material-icons-round" style="color:var(--text-dim)">search</span>
        <input type="text" id="search-input" placeholder="Rechercher..." oninput="search(this.value)">
    </div>
</div>

<div class="cards-grid" id="container"></div>

<div class="fab" onclick="toggleChoice(true)">
  <span class="material-icons-round" style="font-size: 32px;">add</span>
</div>

<div class="popup-overlay" id="choice-popup" onclick="toggleChoice(false)">
  <div class="choice-grid" onclick="event.stopPropagation()">
    <div class="choice-item" onclick="openForm('écrit')"><span class="material-icons-round">edit</span><span>Écrit</span></div>
    <div class="choice-item" onclick="openForm('lien')"><span class="material-icons-round">link</span><span>Lien</span></div>
    <div class="choice-item" onclick="openForm('image')"><span class="material-icons-round">image</span><span>Image</span></div>
    <div class="choice-item" onclick="openForm('vocale')"><span class="material-icons-round" style="color:var(--accent-red)">mic</span><span>Vocale</span></div>
  </div>
</div>

<div class="context-overlay" id="context-overlay" onclick="closeContextMenu()">
    <div class="context-menu" onclick="event.stopPropagation()">
        <div class="menu-item" onclick="handleMenuAction('edit')"><span class="material-icons-round">edit</span> Modifier</div>
        <div class="menu-item" id="pin-text" onclick="handleMenuAction('pin')"><span class="material-icons-round">push_pin</span> Épingler</div>
        <div class="menu-item delete" onclick="handleMenuAction('delete')"><span class="material-icons-round">delete</span> Supprimer</div>
    </div>
</div>

<div class="modal-overlay" id="modal-overlay">
  <div class="modal-sheet">
    <div id="form-title" style="font-family: var(--dot-font); margin-bottom: 20px; text-transform: uppercase; font-size: 11px; color: var(--text-dim)">Nouveau</div>
    <input type="text" id="title" placeholder="Titre (optionnel)">
    <textarea id="content" placeholder="Contenu de la note..." rows="4"></textarea>
    <button class="save-btn" onclick="save()">ENREGISTRER</button>
    <button onclick="closeForm()" style="width:100%; background:none; border:none; color:var(--text-dim); margin-top:15px; font-size: 11px; font-family: var(--dot-font)">ANNULER</button>
  </div>
</div>

<script>
let items = JSON.parse(localStorage.getItem('nothing_memoire_final')) || [];
let currentType = 'écrit';
let selectedIndex = null;
let pressTimer = null;
let isScrolling = false;

// Correction : Détection du scroll pour annuler l'appui long
window.addEventListener('touchmove', () => { isScrolling = true; clearTimeout(pressTimer); }, {passive: true});
window.addEventListener('touchstart', () => { isScrolling = false; }, {passive: true});

function render(data = items) {
    const container = document.getElementById('container');
    if (data.length === 0) {
        container.innerHTML = `<div style="grid-column: span 2; text-align:center; padding: 50px; color: var(--text-dim); font-family: var(--dot-font); font-size:12px;">AUCUNE NOTE</div>`;
        return;
    }
    container.innerHTML = data.map((item, i) => `
        <div class="card ${item.pinned ? 'pinned' : ''}" 
             onmousedown="handlePressStart(${i}, event)" onmouseup="handlePressEnd(event)" 
             ontouchstart="handlePressStart(${i}, event)" ontouchend="handlePressEnd(event)">
            ${item.pinned ? '<div class="pin-dot"></div>' : ''}
            <div>
                <div class="card-type">${item.type}</div>
                <div class="card-title">${item.title || 'Sans titre'}</div>
                <div class="card-content">${item.content}</div>
            </div>
            <div class="card-date">${item.date}</div>
        </div>
    `).join('');
}

// --- GESTION APPUI LONG ---
function handlePressStart(index, e) {
    if (isScrolling) return;
    const card = e.currentTarget;
    card.classList.add('pressing');
    pressTimer = setTimeout(() => {
        card.classList.remove('pressing');
        openContextMenu(index);
    }, 600);
}

function handlePressEnd(e) {
    clearTimeout(pressTimer);
    e.currentTarget.classList.remove('pressing');
}

function openContextMenu(index) {
    selectedIndex = index;
    const isPinned = items[index].pinned;
    document.getElementById('pin-text').innerHTML = isPinned ? 
        `<span class="material-icons-round">push_pin</span> Détacher` : 
        `<span class="material-icons-round">push_pin</span> Épingler`;
    document.getElementById('context-overlay').style.display = 'flex';
    if (window.navigator.vibrate) window.navigator.vibrate(50);
}

function closeContextMenu() { document.getElementById('context-overlay').style.display = 'none'; }

function handleMenuAction(action) {
    closeContextMenu();
    if (action === 'delete') {
        items.splice(selectedIndex, 1);
    } else if (action === 'pin') {
        items[selectedIndex].pinned = !items[selectedIndex].pinned;
        // Tri : Épinglés en premier, puis par date
        items.sort((a, b) => b.pinned - a.pinned);
    } else if (action === 'edit') {
        const item = items[selectedIndex];
        openForm(item.type, true);
        document.getElementById('title').value = item.title;
        document.getElementById('content').value = item.content;
        return;
    }
    saveAndRefresh();
}

// --- FORMULAIRE ---
function toggleChoice(show) { document.getElementById('choice-popup').style.display = show ? 'flex' : 'none'; }

function openForm(type, isEdit = false) {
    currentType = type;
    if (!isEdit) {
        selectedIndex = null;
        document.getElementById('title').value = '';
        document.getElementById('content').value = '';
    }
    toggleChoice(false);
    document.getElementById('form-title').innerText = isEdit ? "Modifier " + type : "Nouveau " + type;
    document.getElementById('modal-overlay').style.display = 'flex';
    setTimeout(() => document.getElementById('modal-overlay').classList.add('active'), 10);
}

function closeForm() {
    document.getElementById('modal-overlay').classList.remove('active');
    setTimeout(() => document.getElementById('modal-overlay').style.display = 'none', 300);
}

function save() {
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();
    
    if (!title && !content) return alert("La note est vide !");

    const now = new Date();
    const dateStr = `${now.getDate().toString().padStart(2, '0')}.${(now.getMonth()+1).toString().padStart(2, '0')}.${now.getFullYear().toString().slice(-2)}`;

    if (selectedIndex !== null) {
        items[selectedIndex] = { ...items[selectedIndex], title, content };
    } else {
        items.unshift({ title, content, type: currentType, date: dateStr, pinned: false });
    }
    
    saveAndRefresh();
    closeForm();
}

function saveAndRefresh() {
    localStorage.setItem('nothing_memoire_final', JSON.stringify(items));
    render();
}

function search(q) {
    const filtered = items.filter(i => 
        i.title.toLowerCase().includes(q.toLowerCase()) || 
        i.content.toLowerCase().includes(q.toLowerCase())
    );
    render(filtered);
}

// Initialisation
render();
</script>
</body>
</html>
