<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
<title>Mémoire - Vos Souvenirs</title>

<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

<style>
:root {
  --md-primary:           #6750A4;
  --md-on-primary:        #FFFFFF;
  --md-primary-container: #EADDFF;
  --md-on-primary-container: #21005D;
  --md-secondary-container: #E8DEF8;
  --md-on-secondary-container: #1D192B;
  --md-surface:           #FFFBFE;
  --md-surface-variant:   #E7E0EC;
  --md-on-surface:        #1C1B1F;
  --md-on-surface-variant:#49454F;
  --md-outline-variant:   #CAC4D0;
  --md-error:             #B3261E;
  
  --md-elevation-1: 0 1px 2px rgba(0,0,0,.1);
  --md-elevation-3: 0 4px 8px 3px rgba(0,0,0,.07);
}

/* --- RESET & BASE --- */
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

body {
  font-family: 'Inter', sans-serif;
  background: var(--md-surface);
  color: var(--md-on-surface);
  min-height: 100vh;
  /* Support des encoches/barres système sur mobile */
  padding: env(safe-area-inset-top) 0 0 0;
}

/* --- CHARGEMENT --- */
#loading-screen {
  position: fixed; inset: 0; background: var(--md-surface);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 20px; z-index: 9999;
}
.loader { width: 48px; height: 48px; border: 4px solid var(--md-primary-container); border-top: 4px solid var(--md-primary); border-radius: 50%; animation: spin 1s linear infinite; }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

/* --- AUTHENTIFICATION --- */
#auth-screen {
  min-height: 100vh; display: none; align-items: center; justify-content: center; padding: 20px;
  background: linear-gradient(135deg, #F0EAFB 0%, #FDE8F2 100%);
}
.auth-card {
  background: var(--md-surface); border-radius: 28px; width: 100%; max-width: 400px;
  box-shadow: var(--md-elevation-3); overflow: hidden;
}
.auth-header { padding: 32px 24px; text-align: center; background: var(--md-primary-container); }
.auth-tabs { display: flex; padding: 8px; gap: 8px; }
.auth-tab { flex: 1; padding: 12px; border: none; border-radius: 9999px; background: transparent; cursor: pointer; font-weight: 600; }
.auth-tab.active { background: var(--md-primary); color: white; }

/* --- LAYOUT PRINCIPAL --- */
#app-screen { display: none; }

.app-header {
  position: sticky; top: 0; z-index: 100; background: rgba(255,251,254,0.9);
  backdrop-filter: blur(10px); padding: 12px 16px; border-bottom: 1px solid var(--md-outline-variant);
}
.header-content { display: flex; align-items: center; justify-content: space-between; max-width: 1200px; margin: 0 auto; gap: 16px; }

.search-bar {
  flex: 1; display: flex; align-items: center; gap: 8px; background: var(--md-surface-variant);
  padding: 8px 16px; border-radius: 9999px;
}
.search-bar input { border: none; background: transparent; outline: none; width: 100%; font-size: 16px; }

.app-container { display: flex; max-width: 1200px; margin: 0 auto; width: 100%; }

/* Navigation Latérale (Desktop) */
.side-nav { width: 280px; padding: 24px 16px; position: sticky; top: 70px; height: calc(100vh - 70px); }
.nav-btn {
  display: flex; align-items: center; gap: 12px; width: 100%; padding: 14px 24px;
  border: none; background: transparent; border-radius: 9999px; cursor: pointer;
  font-family: 'Nunito', sans-serif; font-weight: 600; margin-bottom: 4px;
}
.nav-btn.active { background: var(--md-secondary-container); color: var(--md-on-secondary-container); }

/* Zone de contenu */
.main-feed { flex: 1; padding: 20px; min-width: 0; }

.cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(min(100%, 280px), 1fr));
  gap: 16px;
}

/* --- CARTES --- */
.card {
  background: var(--md-surface); border: 1px solid var(--md-outline-variant);
  border-radius: 16px; padding: 16px; transition: transform 0.2s; position: relative;
}
.card:hover { transform: translateY(-2px); box-shadow: var(--md-elevation-1); }
.card-tag { font-size: 10px; font-weight: 800; text-transform: uppercase; color: var(--md-primary); margin-bottom: 8px; display: block; }
.card-title { font-family: 'Nunito', sans-serif; font-weight: 700; margin-bottom: 8px; }
.card-image { width: 100%; height: 180px; object-fit: cover; border-radius: 12px; margin: 8px 0; }
.card-text { font-size: 14px; color: var(--md-on-surface-variant); line-height: 1.5; }

/* --- BOUTON FLOTTANT (FAB) --- */
.fab {
  position: fixed; bottom: 32px; right: 24px; z-index: 200;
  display: flex; align-items: center; gap: 8px; padding: 16px 24px;
  background: var(--md-primary-container); color: var(--md-on-primary-container);
  border: none; border-radius: 16px; font-weight: 700; box-shadow: var(--md-elevation-3); cursor: pointer;
}

/* --- NAVIGATION BASSE (MOBILE) --- */
.bottom-nav {
  display: none; position: fixed; bottom: 0; left: 0; right: 0;
  background: var(--md-surface); border-top: 1px solid var(--md-outline-variant);
  padding: 8px 0 calc(8px + env(safe-area-inset-bottom)); z-index: 150; justify-content: space-around;
}
.bn-item { border: none; background: transparent; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 11px; color: var(--md-on-surface-variant); }
.bn-item.active { color: var(--md-primary); font-weight: 700; }

/* --- RESPONSIVITÉ --- */
@media (max-width: 768px) {
  .side-nav { display: none; }
  .bottom-nav { display: flex; }
  .main-feed { padding-bottom: 100px; }
  .fab { bottom: calc(85px + env(safe-area-inset-bottom)); right: 16px; }
  .app-title { font-size: 20px; }
}

/* --- MODALE --- */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
  display: none; align-items: flex-end; justify-content: center; z-index: 300;
}
.modal-overlay.open { display: flex; }
.modal-sheet {
  background: var(--md-surface); width: 100%; max-width: 550px;
  border-radius: 28px 28px 0 0; padding: 24px; padding-bottom: calc(24px + env(safe-area-inset-bottom));
}

/* Formulaire */
.field { margin-bottom: 16px; }
.field label { display: block; font-size: 12px; font-weight: 700; margin-bottom: 6px; color: var(--md-primary); }
.field input, .field textarea {
  width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--md-outline-variant); font-size: 16px;
}
.btn-save { background: var(--md-primary); color: white; width: 100%; padding: 14px; border: none; border-radius: 9999px; font-weight: 700; cursor: pointer; }

#toast {
  position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
  background: #322F35; color: white; padding: 12px 24px; border-radius: 8px;
  opacity: 0; transition: 0.3s; z-index: 1000;
}
#toast.show { opacity: 1; }
</style>
</head>
<body>

<div id="loading-screen"><div class="loader"></div><p>Chargement de vos souvenirs...</p></div>

<div id="auth-screen">
  <div class="auth-card">
    <div class="auth-header">
      <h1 style="font-family:'Nunito';">Mémoire</h1>
    </div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="t-login" onclick="setAuthMode('login')">Connexion</button>
      <button class="auth-tab" id="t-reg" onclick="setAuthMode('reg')">Inscription</button>
    </div>
    <div style="padding:24px;">
      <div class="field"><label>Email</label><input type="email" id="auth-email"></div>
      <div class="field"><label>Mot de passe</label><input type="password" id="auth-pass"></div>
      <button class="btn-save" id="auth-btn" onclick="handleAuth()">Continuer</button>
      <p id="auth-err" style="color:var(--md-error); font-size:12px; margin-top:12px; text-align:center;"></p>
    </div>
  </div>
</div>

<div id="app-screen">
  <header class="app-header">
    <div class="header-content">
      <h2 class="app-title" style="font-family:'Nunito'; color:var(--md-primary);">Mémoire</h2>
      <div class="search-bar">
        <span class="material-icons-round">search</span>
        <input type="text" placeholder="Rechercher..." oninput="doSearch(this.value)">
      </div>
      <button onclick="logout()" style="border:none; background:none; cursor:pointer;"><span class="material-icons-round">logout</span></button>
    </div>
  </header>

  <div class="app-container">
    <nav class="side-nav">
      <button class="nav-btn active" onclick="setFilter('all')"><span class="material-icons-round">grid_view</span> Tout</button>
      <button class="nav-btn" onclick="setFilter('note')"><span class="material-icons-round">description</span> Notes</button>
      <button class="nav-btn" onclick="setFilter('link')"><span class="material-icons-round">link</span> Liens</button>
      <button class="nav-btn" onclick="setFilter('image')"><span class="material-icons-round">image</span> Images</button>
    </nav>

    <main class="main-feed">
      <div class="cards-grid" id="grid"></div>
    </main>
  </div>

  <button class="fab" onclick="openAdd()">
    <span class="material-icons-round">add</span> Nouveau
  </button>

  <nav class="bottom-nav">
    <button class="bn-item active" onclick="setFilter('all')"><span class="material-icons-round">grid_view</span>Tout</button>
    <button class="bn-item" onclick="setFilter('note')"><span class="material-icons-round">description</span>Notes</button>
    <button class="bn-item" onclick="setFilter('link')"><span class="material-icons-round">link</span>Liens</button>
    <button class="bn-item" onclick="setFilter('image')"><span class="material-icons-round">image</span>Images</button>
  </nav>
</div>

<div class="modal-overlay" id="modal" onclick="if(event.target==this) closeAdd()">
  <div class="modal-sheet">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h3 style="font-family:'Nunito';">Ajouter un souvenir</h3>
      <button onclick="closeAdd()" style="border:none; background:none;"><span class="material-icons-round">close</span></button>
    </div>

    <div class="field">
      <label>Type</label>
      <select id="item-type" onchange="toggleFields(this.value)" style="width:100%; padding:12px; border-radius:12px;">
        <option value="note">Note</option>
        <option value="link">Lien</option>
        <option value="image">Image</option>
      </select>
    </div>

    <div class="field"><label>Titre</label><input type="text" id="item-title"></div>
    <div class="field" id="f-content"><label>Contenu</label><textarea id="item-text" rows="4"></textarea></div>
    <div class="field" id="f-url" style="display:none"><label>URL</label><input type="url" id="item-url"></div>
    <div class="field" id="f-img" style="display:none">
      <label>Photo</label>
      <input type="file" accept="image/*" onchange="handleImg(event)">
    </div>

    <button class="btn-save" onclick="save()">Enregistrer</button>
  </div>
</div>

<div id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// --- CONFIG SUPABASE ---
const S_URL = 'https://yunjmlmzepbsahsavibb.supabase.co';
const S_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1bmptbG16ZXBic2Foc2F2aWJiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0ODg3MzUsImV4cCI6MjA4NzA2NDczNX0.xqooMTdVJH_ZH-Cdb4BIQgxNTIuJCA1r7yhOMGwoVvk';
const sb = supabase.createClient(S_URL, S_KEY);

let user = null, items = [], filter = 'all', search = '', authMode = 'login', tempImg = null;

async function init() {
  const { data: { session } } = await sb.auth.getSession();
  if(session) startApp(session.user); else show('auth');
  
  sb.auth.onAuthStateChange((ev, sess) => {
    if(sess) startApp(sess.user); else show('auth');
  });
}

function show(s) {
  document.getElementById('loading-screen').style.display = 'none';
  document.getElementById('auth-screen').style.display = s === 'auth' ? 'flex' : 'none';
  document.getElementById('app-screen').style.display = s === 'app' ? 'block' : 'none';
}

// --- AUTH ---
function setAuthMode(m) {
  authMode = m;
  document.getElementById('t-login').classList.toggle('active', m === 'login');
  document.getElementById('t-reg').classList.toggle('active', m === 'reg');
}

async function handleAuth() {
  const email = document.getElementById('auth-email').value;
  const pass = document.getElementById('auth-pass').value;
  const btn = document.getElementById('auth-btn');
  btn.disabled = true;

  const { data, error } = (authMode === 'login') 
    ? await sb.auth.signInWithPassword({ email, password: pass })
    : await sb.auth.signUp({ email, password: pass });

  if(error) document.getElementById('auth-err').textContent = error.message;
  btn.disabled = false;
}

async function startApp(u) { user = u; show('app'); load(); }
async function logout() { await sb.auth.signOut(); }

// --- LOGIQUE DATA ---
async function load() {
  const { data } = await sb.from('items').select('*').order('created_at', { ascending: false });
  items = data || [];
  render();
}

function render() {
  const grid = document.getElementById('grid');
  const filtered = items.filter(i => {
    const mType = filter === 'all' || i.type === filter;
    const mSearch = i.title.toLowerCase().includes(search.toLowerCase()) || (i.content || '').toLowerCase().includes(search.toLowerCase());
    return mType && mSearch;
  });

  grid.innerHTML = filtered.map(i => `
    <div class="card">
      <span class="card-tag">${i.type}</span>
      <div class="card-title">${i.title}</div>
      ${i.image_data ? `<img src="${i.image_data}" class="card-image">` : ''}
      <div class="card-text">${i.content || ''}</div>
      ${i.url ? `<a href="${i.url}" target="_blank" style="font-size:12px; color:var(--md-primary); text-decoration:none; display:block; margin-top:8px;">Ouvrir le lien →</a>` : ''}
      <button onclick="del('${i.id}')" style="position:absolute; top:12px; right:12px; border:none; background:none; color:#ccc; cursor:pointer;"><span class="material-icons-round" style="font-size:18px;">delete</span></button>
    </div>
  `).join('');
}

// --- UI ACTIONS ---
function setFilter(f) {
  filter = f;
  document.querySelectorAll('.nav-btn, .bn-item').forEach(b => {
    const isMatch = b.textContent.toLowerCase().includes(f === 'all' ? 'tout' : f);
    b.classList.toggle('active', isMatch);
  });
  render();
}

function doSearch(v) { search = v; render(); }

function openAdd() { document.getElementById('modal').classList.add('open'); }
function closeAdd() { document.getElementById('modal').classList.remove('open'); tempImg = null; }

function toggleFields(v) {
  document.getElementById('f-content').style.display = v === 'note' ? 'block' : 'none';
  document.getElementById('f-url').style.display = v === 'link' ? 'block' : 'none';
  document.getElementById('f-img').style.display = v === 'image' ? 'block' : 'none';
}

function handleImg(e) {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = (ev) => tempImg = ev.target.result;
  reader.readAsDataURL(file);
}

async function save() {
  const type = document.getElementById('item-type').value;
  const title = document.getElementById('item-title').value;
  const content = document.getElementById('item-text').value;
  const url = document.getElementById('item-url').value;

  const { error } = await sb.from('items').insert([{
    user_id: user.id, type, title, content, url, image_data: tempImg
  }]);

  if(!error) { closeAdd(); load(); toast("Souvenir enregistré !"); }
}

async function del(id) {
  if(confirm("Supprimer ?")) {
    await sb.from('items').delete().eq('id', id);
    load();
  }
}

function toast(m) {
  const t = document.getElementById('toast'); t.textContent = m; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 3000);
}

init();
</script>
</body>
</html>
