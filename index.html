<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Essential Space</title>

<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#080808">

<style>
:root{
  --bg:#080808; --bg2:#101010; --card:#141414; --card2:#1C1C1C;
  --text:#F0F0F0; --text-dim:#666666; --border:#282828; --border2:#333333;
  --accent:#FFD000; --accent-fg:#080808; --red:#FF3333;
  --dot-font:'Space Mono', monospace;
  --radius-sm:10px; --radius-md:16px; --radius-lg:24px; --radius-xl:32px;
}
body.light-theme{
  --bg:#E4E4E4; --bg2:#DADADA; --card:#F0F0F0; --card2:#E8E8E8;
  --text:#111111; --text-dim:#888888; --border:#C8C8C8; --border2:#BBBBBB;
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:var(--dot-font); background:var(--bg); color:var(--text);
  padding-bottom:130px; overflow-x:hidden; transition:background .25s,color .25s;
}

/* header */
.app-header{position:sticky;top:0;z-index:1000;padding:18px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);background:var(--bg)}
.logo-wrap{display:flex;align-items:center;gap:10px}
.logo{font-size:13px;font-weight:700;text-transform:uppercase;letter-spacing:3px;color:var(--text)}

/* icons */
.header-icons{display:flex;align-items:center;gap:8px}
.icon-btn{width:38px;height:38px;border-radius:50%;background:var(--card);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer}
.icon-btn .material-icons-round{font-size:18px;color:var(--text-dim)}

/* search */
.search-container{padding:14px 20px 0}
.search-bar{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-xl);padding:13px 18px;display:flex;align-items:center;gap:10px}
.search-bar .material-icons-round{color:var(--text-dim);font-size:18px}
.search-bar input{background:none;border:0;outline:0;color:var(--text);width:100%;font-size:13px;font-family:var(--dot-font)}
.search-bar input::placeholder{color:var(--text-dim)}

/* grid */
.cards-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:16px 20px}

/* card */
.card{background:var(--card);border-radius:var(--radius-lg);padding:18px;border:1px solid var(--border);min-height:140px;display:flex;flex-direction:column;justify-content:space-between;position:relative;overflow:hidden;cursor:pointer;transition:transform .15s,border-color .15s}
.card:active{transform:scale(.96);border-color:var(--border2)}
.card::before{content:'';position:absolute;bottom:0;left:0;right:0;height:2px;background:transparent;transition:background .2s}
.card.pinned-card::before{background:var(--red)}
.pin-dot{position:absolute;top:14px;right:14px;width:6px;height:6px;background:var(--red);border-radius:50%;box-shadow:0 0 8px var(--red)}

.card-type{font-size:8px;color:var(--text-dim);text-transform:uppercase;letter-spacing:2px;margin-bottom:8px}
.card-title{font-weight:700;font-size:13px;color:var(--text);margin-bottom:5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:.5px}
.card-content{font-size:11px;line-height:1.5;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;letter-spacing:.3px}
.card-image{width:100%;height:80px;object-fit:cover;border-radius:var(--radius-sm);margin-bottom:8px;cursor:zoom-in}
.card-audio{width:100%;height:30px;margin-top:8px}
.card-date{font-size:8px;color:var(--text-dim);letter-spacing:1.5px;text-transform:uppercase;margin-top:10px}
.empty-state{grid-column:span 2;text-align:center;padding:60px 20px;color:var(--text-dim);font-size:11px;letter-spacing:3px;text-transform:uppercase}
.empty-state .empty-icon{font-size:36px;display:block;margin-bottom:12px;opacity:.3}

/* fab */
.fab-container{position:fixed;bottom:28px;right:20px;z-index:2500}
.fab{width:62px;height:62px;border-radius:50%;background:var(--accent);color:var(--accent-fg);display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(245,183,0,.35);cursor:pointer;border:0}
.fab svg{transition:transform .25s}
.fab:active{transform:scale(.93)}

/* popup */
.popup-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(20px) saturate(.5);z-index:2000;display:none;flex-direction:column;align-items:flex-end;justify-content:flex-end;padding:20px 20px 108px 20px}
.popup-overlay.active{display:flex}
.speed-dial-list{display:flex;flex-direction:column;gap:10px;align-items:flex-end}
.dial-item{display:flex;align-items:center;gap:14px;opacity:0;transform:translateY(16px) scale(.95);transition:opacity .25s,transform .25s}
.popup-overlay.active .dial-item{opacity:1;transform:translateY(0) scale(1)}
.dial-label{font-size:10px;text-transform:uppercase;letter-spacing:2px;color:var(--text);background:var(--card2);border:1px solid var(--border2);padding:7px 14px;border-radius:100px;white-space:nowrap}
.dial-circle{width:52px;height:52px;border-radius:50%;background:var(--card);border:1px solid var(--border2);display:flex;align-items:center;justify-content:center}
.dial-circle .material-icons-round{font-size:22px;color:var(--text)}
.dial-circle.accent-circle{background:var(--accent)}
.dial-circle.accent-circle .material-icons-round{color:var(--accent-fg)}
.dial-circle.red-circle{background:var(--red)}
.dial-circle.red-circle .material-icons-round{color:#fff}

/* modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);backdrop-filter:blur(10px);z-index:2500;display:none;align-items:flex-end}
.modal-overlay.active{display:flex}
.modal-sheet{background:var(--bg2);width:100%;border-radius:var(--radius-xl) var(--radius-xl) 0 0;padding:28px 20px 32px;border-top:2px solid var(--red);transition:transform .3s;transform:translateY(100%);max-height:92vh;overflow-y:auto}
.modal-overlay.active .modal-sheet{transform:translateY(0)}
.modal-sheet::before{content:'';display:block;width:36px;height:3px;background:var(--border2);border-radius:2px;margin:0 auto 22px}
.modal-label{font-size:9px;color:var(--red);text-transform:uppercase;letter-spacing:3px;margin-bottom:16px}
.modal-sheet input,.modal-sheet textarea{width:100%;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-md);padding:15px 16px;color:var(--text);margin-bottom:10px;outline:none;font-size:14px;font-family:var(--dot-font);transition:border-color .15s;letter-spacing:.3px}
.modal-sheet input:focus,.modal-sheet textarea:focus{border-color:var(--red)}
.modal-sheet input::placeholder,.modal-sheet textarea::placeholder{color:var(--text-dim)}
.color-picker{display:flex;gap:8px;margin-bottom:16px;align-items:center}
.color-btn{width:30px;height:30px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:transform .15s,outline .15s;outline:3px solid transparent;outline-offset:2px;flex-shrink:0}
.color-btn:hover{transform:scale(1.12)}
.color-btn.active{outline-color:var(--red)}
.save-btn{width:100%;padding:16px;background:var(--accent);color:var(--accent-fg);border:none;border-radius:100px;font-weight:700;font-family:var(--dot-font);font-size:12px;letter-spacing:2px;text-transform:uppercase;cursor:pointer;margin-top:6px}
.record-btn{width:100%;padding:15px;background:var(--red);color:#fff;border-radius:100px;border:none;margin-bottom:10px;display:none;font-family:var(--dot-font);font-weight:700;font-size:12px;letter-spacing:3px;cursor:pointer}
.record-btn.recording{background:#7a0000;animation:pulse-rec 1s infinite}
@keyframes pulse-rec{0%,100%{opacity:1}50%{opacity:.65}}
.action-bar{display:flex;justify-content:space-around;padding:14px 0;border-top:1px solid var(--border);margin-top:10px}
.action-btn{background:none;border:none;color:var(--text-dim);display:flex;flex-direction:column;align-items:center;gap:5px;font-size:9px;font-family:var(--dot-font);letter-spacing:1.5px;text-transform:uppercase;cursor:pointer}
.action-btn.delete{color:var(--red)}
.action-btn .material-icons-round{font-size:22px}
.close-btn{width:100%;background:none;border:none;color:var(--text-dim);margin-top:14px;font-size:10px;font-family:var(--dot-font);letter-spacing:2px;text-transform:uppercase;cursor:pointer}

/* settings/tips */
.full-overlay{position:fixed;inset:0;z-index:3000;display:none;flex-direction:column;background:var(--bg)}
.full-overlay.active{display:flex}
.overlay-header{display:flex;align-items:center;justify-content:space-between;padding:20px;border-bottom:1px solid var(--border)}
.overlay-title{font-size:12px;text-transform:uppercase;letter-spacing:3px;color:var(--text);display:flex;align-items:center;gap:10px}
.overlay-title-dot{width:8px;height:8px;background:var(--red);border-radius:50%}
.overlay-close{width:36px;height:36px;border-radius:50%;background:var(--card);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer}
.overlay-close .material-icons-round{font-size:18px;color:var(--text-dim)}
.overlay-scroll{overflow-y:auto;flex:1;padding:20px;display:flex;flex-direction:column;gap:8px}
.section-label{font-size:8px;color:var(--text-dim);text-transform:uppercase;letter-spacing:3px;margin:12px 0 6px 4px}
.settings-item{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px 18px;display:flex;align-items:center;gap:14px;cursor:pointer}
.settings-item:active{border-color:var(--red)}
.settings-item-icon{width:36px;height:36px;border-radius:50%;background:var(--card2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center}
.settings-item-icon .material-icons-round{font-size:18px;color:var(--text-dim)}
.theme-options{display:flex;gap:8px;margin-top:12px;width:100%}
.theme-option{flex:1;padding:10px 6px;border-radius:var(--radius-md);border:2px solid var(--border);display:flex;flex-direction:column;align-items:center;gap:7px;cursor:pointer;font-size:8px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1.5px}
.theme-option.selected{border-color:var(--accent);color:var(--accent)}
.theme-option-preview{width:40px;height:26px;border-radius:8px;border:1px solid var(--border)}
.preview-dark{background:#080808}
.preview-light{background:#E4E4E4}
.preview-auto{background:linear-gradient(135deg,#080808 50%,#E4E4E4 50%)}
.tips-overlay{z-index:3500}
.tips-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.tip-card{background:var(--card);border-radius:var(--radius-lg);padding:18px;border:1px solid var(--border);min-height:140px;display:flex;flex-direction:column;justify-content:space-between}
.tip-card-icon{font-size:22px;margin-bottom:10px}
.tip-card-title{font-weight:700;font-size:12px;color:var(--text);margin-bottom:6px;letter-spacing:.5px}
.tip-card-body{font-size:10px;line-height:1.6;color:var(--text-dim);flex:1}
.tip-card-tag{font-size:8px;color:var(--accent);text-transform:uppercase;letter-spacing:2px;margin-top:10px}
.tip-card-tag.red{color:var(--red)}

/* image viewer (lightbox) */
.image-viewer-overlay{
  position:fixed; inset:0; display:none; align-items:center; justify-content:center;
  background:rgba(0,0,0,0.9); z-index:4000; padding:20px;
  transition:opacity .25s, transform .25s;
}
.image-viewer-overlay.active{display:flex; opacity:1}
.image-viewer-overlay img{max-width:95%; max-height:95%; border-radius:8px; box-shadow:0 14px 40px rgba(0,0,0,0.6); cursor:zoom-out}
.image-viewer-overlay .viewer-close{
  position:fixed; top:20px; right:20px; width:44px; height:44px; border-radius:50%;
  background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.06); color:var(--text);
  display:flex; align-items:center; justify-content:center; font-size:20px; cursor:pointer;
}
@media (max-width:480px){
  .card-image{height:120px}
}
</style>
</head>
<body>

<header class="app-header">
  <div class="logo-wrap"><div class="logo">Essential Space</div></div>
  <div class="header-icons">
    <button type="button" class="icon-btn" onclick="toggleTips(true)" aria-label="Astuces"><span class="material-icons-round">help_outline</span></button>
    <button type="button" class="icon-btn" onclick="toggleSettings(true)" aria-label="Param√®tres"><span class="material-icons-round">settings</span></button>
  </div>
</header>

<div class="search-container">
  <div class="search-bar">
    <span class="material-icons-round">search</span>
    <input id="search-input" placeholder="Rechercher..." oninput="search(this.value)" aria-label="Rechercher">
  </div>
</div>

<div class="cards-grid" id="container" aria-live="polite"></div>

<div class="fab-container">
  <button type="button" class="fab" id="main-fab" aria-label="Ajouter" onclick="togglePopup()">
    <svg id="fab-icon" width="30" height="30" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
      <g id="fab-lines" stroke="currentColor" stroke-width="12" stroke-linecap="round" stroke-linejoin="round">
        <line x1="50" y1="16" x2="50" y2="84"></line>
        <g transform="rotate(60 50 50)"><line x1="50" y1="16" x2="50" y2="84"></line></g>
        <g transform="rotate(120 50 50)"><line x1="50" y1="16" x2="50" y2="84"></line></g>
      </g>
    </svg>
  </button>
</div>

<div class="popup-overlay" id="choice-popup" onclick="togglePopup()">
  <div class="speed-dial-list" onclick="event.stopPropagation()">

    <div class="dial-item" role="button" tabindex="0" onclick="openForm('√©crit')" onkeydown="if(event.key==='Enter')openForm('√©crit')">
      <span class="dial-label">√âcrit</span>
      <div class="dial-circle"><span class="material-icons-round">edit_note</span></div>
    </div>

    <div class="dial-item" role="button" tabindex="0" onclick="openForm('lien')" onkeydown="if(event.key==='Enter')openForm('lien')">
      <span class="dial-label">Lien</span>
      <div class="dial-circle"><span class="material-icons-round">link</span></div>
    </div>

    <div class="dial-item" role="button" tabindex="0" onclick="handleImageClick()" onkeydown="if(event.key==='Enter')handleImageClick()">
      <span class="dial-label">Image</span>
      <div class="dial-circle"><span class="material-icons-round">photo_library</span></div>
    </div>

    <div class="dial-item" role="button" tabindex="0" onclick="openForm('vocale')" onkeydown="if(event.key==='Enter')openForm('vocale')">
      <span class="dial-label">Vocale</span>
      <div class="dial-circle red-circle"><span class="material-icons-round">mic</span></div>
    </div>

  </div>
</div>

<div class="modal-overlay" id="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="modal-sheet">
    <div class="modal-label" id="modal-label">NOUVEAU</div>

    <input type="text" id="note-title" placeholder="Titre (optionnel)" aria-label="Titre">

    <img id="preview-img" style="width:100%;max-height:200px;object-fit:contain;display:none;border-radius:var(--radius-md);margin-bottom:10px;border:1px solid var(--border)" onclick="if(this.src) openImageViewer(this.src)" alt="Aper√ßu image">

    <button type="button" id="record-btn" class="record-btn" onclick="toggleRecording()" aria-label="Enregistrer un audio">‚óè MICRO</button>

    <audio id="audio-preview" controls style="display:none;width:100%;margin-bottom:10px;" aria-label="Aper√ßu audio"></audio>

    <textarea id="note-content" placeholder="Contenu..." rows="5" aria-label="Contenu"></textarea>

    <div class="color-picker" id="color-picker-ui">
      <button type="button" id="cbtn-default" class="color-btn active" data-color="default" style="background:var(--text-dim);border-color:var(--border2)" onclick="setTextColor('default')" aria-label="Couleur par d√©faut"></button>
      <button type="button" id="cbtn-red" class="color-btn" data-color="#FF3333" style="background:#FF3333" onclick="setTextColor('#FF3333')" aria-label="Couleur rouge"></button>
      <button type="button" id="cbtn-yellow" class="color-btn" data-color="#FFD000" style="background:#FFD000;border-color:var(--border2)" onclick="setTextColor('#FFD000')" aria-label="Couleur jaune"></button>
      <button type="button" id="cbtn-green" class="color-btn" data-color="#00FF7F" style="background:#00FF7F" onclick="setTextColor('#00FF7F')" aria-label="Couleur verte"></button>
      <button type="button" id="cbtn-blue" class="color-btn" data-color="#00BFFF" style="background:#00BFFF" onclick="setTextColor('#00BFFF')" aria-label="Couleur bleue"></button>
    </div>

    <button type="button" class="save-btn" onclick="saveNote()" aria-label="Enregistrer la note">Enregistrer</button>

    <div class="action-bar" id="edit-actions" style="display:none">
      <button type="button" class="action-btn" id="pin-btn-modal" onclick="togglePinModal()" aria-pressed="false"><span class="material-icons-round">push_pin</span>√âpingler</button>
      <button type="button" class="action-btn delete" onclick="deleteNoteModal()"><span class="material-icons-round">delete</span>Supprimer</button>
    </div>

    <button type="button" class="close-btn" onclick="closeForm()">‚Äî Fermer ‚Äî</button>
  </div>
</div>

<!-- image viewer (lightbox) -->
<div id="image-viewer" class="image-viewer-overlay" onclick="closeImageViewer()" role="dialog" aria-modal="true" aria-hidden="true">
  <button type="button" class="viewer-close" onclick="event.stopPropagation(); closeImageViewer()" aria-label="Fermer l'image">√ó</button>
  <img id="viewer-img" src="" alt="Image agrandie" onclick="event.stopPropagation()">
</div>

<div class="full-overlay" id="settings-overlay" aria-hidden="true">
  <div class="overlay-header">
    <div class="overlay-title"><div class="overlay-title-dot"></div>Param√®tres</div>
    <button type="button" class="overlay-close" onclick="toggleSettings(false)" aria-label="Fermer param√®tres"><span class="material-icons-round">close</span></button>
  </div>
  <div class="overlay-scroll">
    <div class="section-label">Apparence</div>
    <div class="settings-item" style="flex-direction:column;align-items:flex-start;cursor:default;gap:0;">
      <div style="display:flex;align-items:center;gap:14px;width:100%;">
        <div class="settings-item-icon"><span class="material-icons-round">palette</span></div>
        <div class="settings-item-text">
          <div class="settings-item-label">Th√®me</div>
          <div class="settings-item-sub" id="theme-sub-label">Automatique</div>
        </div>
      </div>
      <div class="theme-options">
        <button type="button" class="theme-option" id="theme-opt-dark" onclick="setThemeMode('dark')">
          <div class="theme-option-preview preview-dark"></div>Sombre
        </button>
        <button type="button" class="theme-option" id="theme-opt-light" onclick="setThemeMode('light')">
          <div class="theme-option-preview preview-light"></div>Clair
        </button>
        <button type="button" class="theme-option" id="theme-opt-auto" onclick="setThemeMode('auto')">
          <div class="theme-option-preview preview-auto"></div>Auto
        </button>
      </div>
    </div>

    <div class="section-label">Donn√©es</div>
    <button type="button" class="settings-item" onclick="exportData()" aria-label="Exporter les donn√©es">
      <div class="settings-item-icon"><span class="material-icons-round">ios_share</span></div>
      <div class="settings-item-text"><div class="settings-item-label">Exporter</div><div class="settings-item-sub">Sauvegarder en fichier JSON</div></div>
      <div class="settings-item-arrow"><span class="material-icons-round">chevron_right</span></div>
    </button>

    <button type="button" class="settings-item" onclick="triggerImport()" aria-label="Importer des donn√©es">
      <div class="settings-item-icon"><span class="material-icons-round">download</span></div>
      <div class="settings-item-text"><div class="settings-item-label">Importer</div><div class="settings-item-sub">Restaurer depuis un fichier JSON</div></div>
      <div class="settings-item-arrow"><span class="material-icons-round">chevron_right</span></div>
    </button>
  </div>
</div>

<div class="full-overlay tips-overlay" id="tips-overlay" aria-hidden="true">
  <div class="overlay-header">
    <div class="overlay-title"><div class="overlay-title-dot"></div>Astuces</div>
    <button type="button" class="overlay-close" onclick="toggleTips(false)" aria-label="Fermer astuces"><span class="material-icons-round">close</span></button>
  </div>
  <div class="overlay-scroll">
    <div class="tips-grid">
      <div class="tip-card"><div class="tip-card-icon">‚ú≥</div><div><div class="tip-card-title">Cr√©er une note</div><div class="tip-card-body">Appuie sur le bouton ‚ú≥ en bas √† droite pour choisir le type.</div></div><div class="tip-card-tag">D√©marrer</div></div>
      <div class="tip-card"><div class="tip-card-icon">üìå</div><div><div class="tip-card-title">√âpingler</div><div class="tip-card-body">Ouvre une note et appuie sur √âpingler pour la garder en haut.</div></div><div class="tip-card-tag red">Organisation</div></div>
      <div class="tip-card"><div class="tip-card-icon">üé®</div><div><div class="tip-card-title">Couleur</div><div class="tip-card-body">Utilise la palette lors de la cr√©ation pour personnaliser ton texte.</div></div><div class="tip-card-tag">Personnalisation</div></div>
      <div class="tip-card"><div class="tip-card-icon">üîç</div><div><div class="tip-card-title">Recherche</div><div class="tip-card-body">Filtre tes notes par titre ou contenu en temps r√©el.</div></div><div class="tip-card-tag red">Recherche</div></div>
      <div class="tip-card"><div class="tip-card-icon">üéôÔ∏è</div><div><div class="tip-card-title">Note vocale</div><div class="tip-card-body">Choisis Vocale puis MICRO pour lancer, STOP pour terminer.</div></div><div class="tip-card-tag">Audio</div></div>
      <div class="tip-card"><div class="tip-card-icon">üñºÔ∏è</div><div><div class="tip-card-title">Image</div><div class="tip-card-body">Choisis Image pour ajouter une photo depuis ta galerie.</div></div><div class="tip-card-tag red">M√©dia</div></div>
      <div class="tip-card"><div class="tip-card-icon">üíæ</div><div><div class="tip-card-title">Sauvegarde</div><div class="tip-card-body">Via ‚öôÔ∏è, exporte ou importe tes notes en JSON.</div></div><div class="tip-card-tag">Donn√©es</div></div>
      <div class="tip-card"><div class="tip-card-icon">üåó</div><div><div class="tip-card-title">Th√®me</div><div class="tip-card-body">Via ‚öôÔ∏è, choisis Sombre, Clair, ou Auto selon ton appareil.</div></div><div class="tip-card-tag red">Affichage</div></div>
    </div>
  </div>
</div>

<input type="file" id="image-input" accept="image/*" style="display:none" aria-hidden="true">
<input type="file" id="import-input" accept=".json" style="display:none" onchange="importData(event)" aria-hidden="true">

<script>
/* -------------------------
   √âTAT ET CONFIG
   ------------------------- */
let items = [];
try { items = JSON.parse(localStorage.getItem('essential_space_v2')) || []; } catch(e){ items = []; }
let currentType = '√©crit';
let currentMediaData = null; // dataURL
let editingIndex = null;
let selectedColor = null;
let mediaRecorder = null, audioChunks = [], isRecording = false;
let themeMode = localStorage.getItem('essential_theme_mode') || 'auto';

/* -------------------------
   TH√àME
   ------------------------- */
function getSystemDark(){ return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; }
function isCurrentlyDark(){ return !document.body.classList.contains('light-theme'); }
function defaultColor(){ return isCurrentlyDark() ? '#F0F0F0' : '#111111'; }

function applyTheme(){
  const dark = themeMode === 'dark' || (themeMode === 'auto' && getSystemDark());
  document.body.classList.toggle('light-theme', !dark);
  document.querySelector('meta[name="theme-color"]').setAttribute('content', dark ? '#080808' : '#E4E4E4');
  ['dark','light','auto'].forEach(m => {
    const el = document.getElementById('theme-opt-' + m);
    if(el) el.classList.toggle('selected', themeMode === m);
  });
  const sub = document.getElementById('theme-sub-label');
  if(sub) sub.textContent = themeMode === 'auto' ? 'Automatique (syst√®me)' : themeMode === 'light' ? 'Th√®me clair' : 'Th√®me sombre';
  render();
}
function setThemeMode(mode){ themeMode = mode; try { localStorage.setItem('essential_theme_mode', mode); } catch(e){} applyTheme(); }
if (window.matchMedia) window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', ()=>{ if(themeMode === 'auto') applyTheme(); });

/* -------------------------
   UTILITAIRES S√âCURITAIRES
   ------------------------- */
function escapeHtml(str){ return String(str||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function safeSaveLocalStorage(key, value){
  try { localStorage.setItem(key, value); return true; } catch(e) { alert('Sauvegarde locale impossible : espace insuffisant ou stockage bloqu√©.'); return false; }
}

/* -------------------------
   RENDU DES CARTES
   ------------------------- */
function render(data = items){
  const container = document.getElementById('container');
  if(!data || data.length === 0){
    container.innerHTML = `<div class="empty-state"><span class="empty-icon">‚ú≥</span>Espace vide</div>`;
    return;
  }
  // Build HTML safely
  container.innerHTML = data.map((item,i) => {
    const span = (item.type === 'image' || item.type === 'vocale') ? 'grid-column: span 2;' : '';
    const textColor = item.color || 'var(--text)';
    const pinClass = item.pinned ? 'pinned-card' : '';
    const titleHtml = item.title ? `<div class="card-title">${escapeHtml(item.title)}</div>` : '';
    const contentHtml = `<div class="card-content" style="color:${textColor}">${escapeHtml(item.content || '')}</div>`;
    const dateHtml = `<div class="card-date">${escapeHtml(item.date || '')}</div>`;

    const imageHtml = (item.type === 'image' && item.media) ?
      `<img src="${item.media}" loading="lazy" class="card-image" alt="${escapeHtml(item.title || 'Image')}" data-src="${item.media}" onclick="event.stopPropagation(); openImageViewer(this.dataset.src)">` : '';

    const audioHtml = (item.type === 'vocale' && item.media) ?
      `<audio src="${item.media}" class="card-audio" controls onclick="event.stopPropagation()" aria-label="Lecture audio"></audio>` : '';

    return `
      <div class="card ${pinClass}" style="${span}" onclick="openEdit(${i})" role="button" tabindex="0" onkeydown="if(event.key==='Enter')openEdit(${i})">
        ${item.pinned ? '<div class="pin-dot" aria-hidden="true"></div>' : ''}
        <div>
          <div class="card-type">${escapeHtml(item.type)}</div>
          ${titleHtml}
          ${imageHtml}
          ${audioHtml}
          ${contentHtml}
        </div>
        ${dateHtml}
      </div>`;
  }).join('');
}

/* -------------------------
   COULEURS / PALETTE
   ------------------------- */
const COLOR_TO_BTN = {'default':'cbtn-default','#FF3333':'cbtn-red','#FFD000':'cbtn-yellow','#00FF7F':'cbtn-green','#00BFFF':'cbtn-blue'};
function setTextColor(color){
  selectedColor = (color === 'default') ? null : color;
  document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById(COLOR_TO_BTN[color] || 'cbtn-default'); if(btn) btn.classList.add('active');
  const ta = document.getElementById('note-content');
  let preview = selectedColor || defaultColor();
  ta.style.color = preview;
}

/* -------------------------
   MODAL (RESET / LAYOUT)
   ------------------------- */
function resetModal(keepMedia = false){
  const titleEl = document.getElementById('note-title');
  const contentEl = document.getElementById('note-content');
  titleEl.value = '';
  contentEl.value = '';
  if(!keepMedia){ currentMediaData = null; }
  const previewImg = document.getElementById('preview-img');
  previewImg.style.display = (keepMedia && currentMediaData) ? 'block' : 'none';
  previewImg.src = (keepMedia && currentMediaData) ? currentMediaData : '';
  const audio = document.getElementById('audio-preview');
  audio.style.display = (keepMedia && currentMediaData && currentType === 'vocale') ? 'block' : 'none';
  audio.src = (keepMedia && currentMediaData && currentType === 'vocale') ? currentMediaData : '';
  document.getElementById('edit-actions').style.display = 'none';
  const recordBtn = document.getElementById('record-btn');
  recordBtn.style.display = 'none';
  recordBtn.classList.remove('recording'); recordBtn.innerText = '‚óè MICRO';
  contentEl.style.display = 'block';
  document.getElementById('color-picker-ui').style.display = 'flex';
  setTextColor('default');
}

function applyModalLayout(type){
  const vocale = type === 'vocale';
  document.getElementById('note-content').style.display = vocale ? 'none' : 'block';
  document.getElementById('color-picker-ui').style.display = vocale ? 'none' : 'flex';
  document.getElementById('record-btn').style.display = vocale ? (mediaRecorderSupported() ? 'block' : 'none') : 'none';
}

/* -------------------------
   OUVERTURE FORMULAIRE / √âDITION
   ------------------------- */
function openForm(type){
  editingIndex = null;
  currentType = type;
  const p = document.getElementById('choice-popup');
  if(p && p.classList.contains('active')) togglePopup();
  const keep = !!currentMediaData;
  resetModal(keep);
  document.getElementById('modal-label').innerText = 'NOUVEAU';
  applyModalLayout(type);
  if(type === 'image' && currentMediaData){
    const img = document.getElementById('preview-img'); img.src = currentMediaData; img.style.display = 'block';
  }
  if(type === 'vocale' && currentMediaData){
    const a = document.getElementById('audio-preview'); a.src = currentMediaData; a.style.display = 'block';
  }
  showModal();
}

function openEdit(index){
  editingIndex = index;
  const item = items[index];
  if(!item) return;
  currentType = item.type;
  resetModal(false);
  document.getElementById('modal-label').innerText = 'MODIFIER';
  document.getElementById('note-title').value = item.title || '';
  document.getElementById('edit-actions').style.display = 'flex';
  document.getElementById('pin-btn-modal').setAttribute('aria-pressed', !!item.pinned);
  applyModalLayout(item.type);
  if(item.type !== 'vocale'){
    document.getElementById('note-content').value = item.content || '';
    setTextColor(item.color || 'default');
  }
  if(item.type === 'image' && item.media){ document.getElementById('preview-img').src = item.media; document.getElementById('preview-img').style.display = 'block'; currentMediaData = item.media; }
  if(item.type === 'vocale' && item.media){ document.getElementById('audio-preview').src = item.media; document.getElementById('audio-preview').style.display = 'block'; currentMediaData = item.media; }
  showModal();
}

/* -------------------------
   SAUVEGARDE / √âDITION
   ------------------------- */
function saveNote(){
  // Si la note est √† type vocale, s'assurer d'avoir un m√©dia (nouveau ou existant)
  const effectiveType = editingIndex !== null ? items[editingIndex].type : currentType;
  if(effectiveType === 'vocale' && !currentMediaData && !(editingIndex !== null && items[editingIndex]?.media)){
    alert('Enregistre un audio avant de sauvegarder.'); return;
  }
  const now = new Date();
  const date = `${String(now.getDate()).padStart(2,'0')}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getFullYear()).slice(-2)}`;
  const note = {
    title: document.getElementById('note-title').value.trim(),
    content: document.getElementById('note-content').value.trim(),
    type: effectiveType,
    date: date,
    color: selectedColor,
    media: currentMediaData || (editingIndex !== null ? items[editingIndex].media : null),
    pinned: editingIndex !== null ? !!items[editingIndex].pinned : false
  };
  if(editingIndex !== null) items[editingIndex] = note;
  else items.unshift(note);
  saveToDisk();
  closeForm();
  currentMediaData = null;
}

/* -------------------------
   EPINGLER / SUPPRIMER
   ------------------------- */
function togglePinModal(){
  if(editingIndex === null) return;
  items[editingIndex].pinned = !items[editingIndex].pinned;
  document.getElementById('pin-btn-modal').setAttribute('aria-pressed', items[editingIndex].pinned);
  saveToDisk();
}
function deleteNoteModal(){
  if(editingIndex === null) return;
  if(confirm('Supprimer cette note ?')){
    items.splice(editingIndex,1);
    saveToDisk();
    editingIndex = null;
    closeForm();
  }
}

/* -------------------------
   PERSISTANCE
   ------------------------- */
function saveToDisk(){
  try {
    items.sort((a,b)=> (b.pinned?1:0) - (a.pinned?1:0));
    safeSaveLocalStorage('essential_space_v2', JSON.stringify(items));
    render();
  } catch(e) {
    console.error('Erreur sauvegarde', e);
    alert('Impossible de sauvegarder localement.');
  }
}

/* -------------------------
   RECHERCHE
   ------------------------- */
function search(q){ const query = (q||'').toLowerCase().trim(); if(!query) { render(); return; } render(items.filter(i => ((i.title||'') + ' ' + (i.content||'')).toLowerCase().includes(query))); }

/* -------------------------
   OVERLAYS / MODAL
   ------------------------- */
function showModal(){
  const o = document.getElementById('modal-overlay');
  if(!o) return;
  o.style.display = 'flex';
  setTimeout(()=> o.classList.add('active'),10);
  o.setAttribute('aria-hidden','false');
}
function closeForm(){
  const o = document.getElementById('modal-overlay');
  if(!o) return;
  o.classList.remove('active');
  setTimeout(()=>{ o.style.display = 'none'; resetModal(false); currentMediaData = null; editingIndex = null; o.setAttribute('aria-hidden','true'); },300);
}
function togglePopup(){
  const p = document.getElementById('choice-popup');
  const f = document.getElementById('main-fab');
  if(!p) { return; }
  if(!p.classList.contains('active')){
    p.style.display='flex'; f.classList.add('active'); setTimeout(()=>p.classList.add('active'),10);
  } else {
    p.classList.remove('active'); f.classList.remove('active'); setTimeout(()=>{ p.style.display='none'; },300);
  }
}
function toggleSettings(s){ const el = document.getElementById('settings-overlay'); if(!el) return; el.classList.toggle('active', !!s); el.setAttribute('aria-hidden', !!s ? 'false':'true'); }
function toggleTips(s){ const el = document.getElementById('tips-overlay'); if(!el) return; el.classList.toggle('active', !!s); el.setAttribute('aria-hidden', !!s ? 'false':'true'); }

/* -------------------------
   EXPORT / IMPORT
   ------------------------- */
function exportData(){
  try {
    const blob = new Blob([JSON.stringify(items,null,2)],{type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'essential_space_' + new Date().toISOString().slice(0,10) + '.json';
    document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    toggleSettings(false);
  } catch(e) { alert('Erreur lors de l\'export.'); }
}
function triggerImport(){ document.getElementById('import-input').click(); }
function importData(event){
  const file = event.target.files[0]; if(!file) return;
  const r = new FileReader();
  r.onload = ev => {
    try {
      const d = JSON.parse(ev.target.result);
      if(!Array.isArray(d)){ alert('Fichier invalide : structure attendue non trouv√©e.'); return; }
      // basic validation of items structure (not exhaustive)
      const ok = d.every(it => it && typeof it.type === 'string' && typeof it.date === 'string');
      if(!ok){ alert('Fichier JSON incompatible.'); return; }
      items = d;
      saveToDisk();
      toggleSettings(false);
      alert(d.length + ' note(s) import√©e(s).');
    } catch(e){ alert('Erreur de lecture JSON.'); }
  };
  r.readAsText(file); event.target.value = '';
}

/* -------------------------
   GESTION MEDIA (IMAGE / AUDIO)
   ------------------------- */
function handleImageClick(){ const p = document.getElementById('choice-popup'); if(p && p.classList.contains('active')) togglePopup(); document.getElementById('image-input').click(); }
document.getElementById('image-input').onchange = e => {
  const file = e.target.files[0]; if(!file) return;
  const r = new FileReader();
  r.onload = ev => { currentMediaData = ev.target.result; openForm('image'); };
  r.readAsDataURL(file); e.target.value = '';
};

/* MediaRecorder support check and graceful fallback */
function mediaRecorderSupported(){ return typeof window.MediaRecorder === 'function' || typeof window.MediaRecorder === 'object'; }

async function toggleRecording(){
  const btn = document.getElementById('record-btn');
  if(!mediaRecorderSupported()){
    alert('Enregistrement audio non support√© par ce navigateur.');
    return;
  }
  if(!isRecording){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      mediaRecorder = new MediaRecorder(stream); audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(audioChunks, {type:'audio/webm'});
        const r = new FileReader();
        r.onload = ev => {
          currentMediaData = ev.target.result;
          const a = document.getElementById('audio-preview'); a.src = ev.target.result; a.style.display = 'block';
        };
        r.readAsDataURL(blob);
        try{ stream.getTracks().forEach(t => t.stop()); }catch(e){}
      };
      mediaRecorder.start(); isRecording = true;
      btn.innerText = '‚ñ† STOP'; btn.classList.add('recording');
    } catch(err){ alert('Acc√®s au microphone refus√© ou erreur : ' + (err && err.message || '')); }
  } else {
    try{ mediaRecorder && mediaRecorder.state !== 'inactive' && mediaRecorder.stop(); }catch(e){}
    isRecording = false; btn.innerText = '‚óè MICRO'; btn.classList.remove('recording');
  }
}

/* -------------------------
   VISIONNEUR D'IMAGES (LIGHTBOX)
   ------------------------- */
function openImageViewer(src){
  if(!src) return;
  const ov = document.getElementById('image-viewer');
  const img = document.getElementById('viewer-img');
  img.src = src;
  ov.style.display = 'flex';
  setTimeout(()=> ov.classList.add('active'), 10);
  // prevent background scroll
  document.body.style.overflow = 'hidden';
  ov.setAttribute('aria-hidden','false');
}
function closeImageViewer(){
  const ov = document.getElementById('image-viewer');
  if(!ov) return;
  ov.classList.remove('active');
  setTimeout(()=>{ 
    ov.style.display = 'none';
    const img = document.getElementById('viewer-img'); img.src = '';
    document.body.style.overflow = '';
    ov.setAttribute('aria-hidden','true');
  }, 200);
}

/* -------------------------
   INITIALISATION / D√âMARRAGE
   ------------------------- */
(function init(){
  applyTheme();
  // Hide record button if unsupported
  if(!mediaRecorderSupported()){
    const rec = document.getElementById('record-btn');
    if(rec) { rec.style.display = 'none'; }
  }
  render();
})();

/* -------------------------
   RACCORDEMENTS G√âN√âRAUX
   ------------------------- */
// Esc pour fermer viewer/modal/popup
document.addEventListener('keydown', e => {
  if(e.key === 'Escape'){
    const modal = document.getElementById('modal-overlay');
    const popup = document.getElementById('choice-popup');
    const viewer = document.getElementById('image-viewer');
    if(viewer && viewer.classList.contains('active')) closeImageViewer();
    else if(modal && modal.classList.contains('active')) closeForm();
    else if(popup && popup.classList.contains('active')) togglePopup();
  }
});

// Emp√™cher le scroll du fond quand lightbox est ouvert sur certains mobiles (d√©j√† g√©r√© mais double-check)
document.getElementById('image-viewer').addEventListener('touchmove', function(e){ e.stopPropagation(); }, { passive: false });

</script>
</body>
</html>
